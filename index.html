<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WoW Classic Raid Crafter - Turtle WoW Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #0a0a0a;
        color: #e0e0e0;
        font-family: "Inter", system-ui, sans-serif;
      }
      .card {
        background-color: #121212;
        border: 1px solid #282828;
      }
      .input-qty {
        background-color: #1a1a1a;
        border-left: 1px solid #333;
        border-right: 1px solid #333;
        color: white;
        outline: none;
      }
      .rarity-uncommon {
        color: #1eff00;
      }
      .rarity-rare {
        color: #0070dd;
      }
      .rarity-epic {
        color: #a335ee;
      }
      .gold {
        color: #ffcc00;
        font-weight: bold;
      }
      .silver {
        color: #c0c0c0;
        font-weight: bold;
      }
      .stepper-btn {
        @apply px-3 py-1 bg-zinc-800 hover:bg-zinc-700 active:bg-zinc-600 transition-colors font-bold text-gray-300;
      }

      /* Custom Scrollbar */
      .custom-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 10px;
      }

      /* Tooltip */
      .tooltip-container {
        position: relative;
        cursor: help;
      }
      .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #050505;
        color: #fff;
        border: 1px solid #ffd100;
        padding: 10px;
        border-radius: 6px;
        position: absolute;
        z-index: 50;
        bottom: 130%;
        left: 0;
        opacity: 0;
        transition: all 0.2s ease;
        font-size: 0.7rem;
        pointer-events: none;
      }
      .tooltip-container:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
        transform: translateY(-5px);
      }

      img {
        height: fit-content;
      }
    </style>
  </head>
  <body class="flex flex-col lg:flex-row min-h-screen">
    <script>
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeName === "IFRAME" && node.src.includes("google")) {
              console.warn("Blocked unauthorized iframe:", node.src);
              node.remove();
            }
          });
        });
      });
      observer.observe(document.documentElement, {
        childList: true,
        subtree: true,
      });
    </script>

    <aside
      class="w-full lg:w-72 bg-[#0d0d0d] border-r border-zinc-800 p-6 lg:h-screen lg:sticky lg:top-0 custom-scroll overflow-y-auto"
    >
      <h2
        class="text-green-500 font-black mb-6 uppercase tracking-widest text-xs border-b border-green-900/30 pb-2 flex justify-between items-center"
      >
        üåø Live Market
        <span
          id="fetch-status"
          class="text-[9px] text-zinc-600 font-normal animate-pulse"
          >updating...</span
        >
      </h2>
      <div id="plant-list" class="space-y-4"></div>
    </aside>

    <main class="flex-1 p-4 md:p-8">
      <div class="max-w-5xl mx-auto">
        <header
          class="mb-8 border-b border-yellow-800/40 pb-6 flex justify-between items-end"
        >
          <div>
            <h1
              class="text-4xl font-black text-yellow-500 tracking-tighter uppercase italic"
            >
              Raid Crafter
            </h1>
            <p
              class="text-zinc-500 text-xs font-medium tracking-widest uppercase"
            >
              Turtle-WoW Ambershire AH Integration
            </p>
          </div>
          <div class="text-right">
            <div id="total-cost" class="text-white mb-2 flex">
              Total
            </div>
            <button
              onclick="window.location.reload()"
              class="bg-zinc-900 hover:bg-red-950/30 text-zinc-500 hover:text-red-500 border border-zinc-800 px-3 py-1 rounded text-[10px] font-bold tracking-widest transition-all"
            >
              REFRESH PRICES
            </button>
          </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10 text-xs">
          <section class="card p-5 rounded-xl shadow-lg">
            <h2
              class="text-orange-500 font-black mb-4 uppercase tracking-widest border-b border-orange-900/30 pb-2"
            >
              ‚öîÔ∏è Melee
            </h2>
            <div id="cac-list" class="space-y-3"></div>
          </section>
          <section class="card p-5 rounded-xl shadow-lg">
            <h2
              class="text-blue-400 font-black mb-4 uppercase tracking-widest border-b border-blue-900/30 pb-2"
            >
              ‚ú® Spells
            </h2>
            <div id="spell-list" class="space-y-3"></div>
          </section>
          <section class="card p-5 rounded-xl shadow-lg">
            <h2
              class="text-purple-400 font-black mb-4 uppercase tracking-widest border-b border-purple-900/30 pb-2"
            >
              üõ°Ô∏è Flasks
            </h2>
            <div id="utils-list" class="space-y-3"></div>
          </section>
        </div>

        <section class="card p-6 rounded-xl shadow-2xl">
          <h2 class="text-lg font-bold mb-6 text-yellow-500">
            üìã Material Shopping List
          </h2>
          <table class="w-full text-sm text-left">
            <thead
              class="text-zinc-500 uppercase text-[10px] tracking-widest border-b border-zinc-800"
            >
              <tr>
                <th class="py-3">Ingredient</th>
                <th class="py-3 text-center">Have</th>
                <th class="py-3 text-center">Need</th>
                <th class="py-3 text-right">Status</th>
              </tr>
            </thead>
            <tbody id="recap-body" class="divide-y divide-zinc-800/50"></tbody>
          </table>
          <div id="empty-msg" class="text-center py-16 text-zinc-700 italic">
            Select quantities to generate shopping list...
          </div>
          <div id="total-cost"></div>
        </div>
      </section>
    </div>

    <script>
      const BUILD_ID = "uT0Wc_Uhbe5mhpGkk6ziK";
      const BASE_URL = `https://www.wowauctions.net/_next/data/${BUILD_ID}/auctionHouse/turtle-wow/ambershire/mergedAh`;

      let plants = [];
      /*
      [
        { name: "Black Lotus", id: 13468, rarity: "epic", price: 35.0 },
        { name: "Icecap", id: 13467, rarity: "uncommon", price: 0.85 },
        { name: "Plaguebloom", id: 13466, rarity: "uncommon", price: 1.1 },
        {
          name: "Mountain Silversage",
          id: 13465,
          rarity: "uncommon",
          price: 0.9,
        },
        { name: "Dreamfoil", id: 13463, rarity: "uncommon", price: 0.55 },
        { name: "Gromsblood", id: 8846, rarity: "uncommon", price: 0.4 },
        { name: "Ghost Mushroom", id: 8845, rarity: "uncommon", price: 1.25 },
        { name: "Crystal Vial", id: 8925, rarity: "common", price: 0.05 },
      ];*/

      async function loadPlants() {
        try {
          // 1. Fetch the JSON file
          const response = await fetch("plants_data.json");
          plants = await response.json();
          document.getElementById("fetch-status").innerText = "live";
        } catch (error) {
          console.error("Error loading JSON:", error);
        }
      }

      const potions = [
        {
          id: "mongoose",
          cat: "cac",
          ico: "üê±",
          name: "Mongoose Elixir",
          rarity: "uncommon",
          desc: "+25 Agility, +2% Crit.",
          mats: { "Mountain Silversage": 2, Plaguebloom: 2, "Crystal Vial": 1 },
        },
        {
          id: "giants",
          cat: "cac",
          ico: "üëπ",
          name: "Elixir of Giants",
          rarity: "uncommon",
          desc: "+25 Strength.",
          mats: { Sungrass: 1, Gromsblood: 1, "Crystal Vial": 1 },
        },
        {
          id: "rage",
          cat: "cac",
          ico: "üò°",
          name: "Mighty Rage Potion",
          rarity: "uncommon",
          desc: "Rage burst.",
          mats: { Gromsblood: 3, "Crystal Vial": 1 },
        },

        {
          id: "firepower",
          cat: "spell",
          ico: "üî•",
          name: "Firepower",
          rarity: "uncommon",
          desc: "+40 Fire Damage.",
          mats: { Firebloom: 2, "Fire Oil": 3, "Crystal Vial": 1 },
        },
        {
          id: "shadowpower",
          cat: "spell",
          ico: "üåë",
          name: "Shadow Power",
          rarity: "uncommon",
          desc: "+40 Shadow Damage.",
          mats: { "Ghost Mushroom": 3, "Crystal Vial": 1 },
        },
        {
          id: "arcane",
          cat: "spell",
          ico: "üîÆ",
          name: "Greater Arcane",
          rarity: "uncommon",
          desc: "+35 Spell Power.",
          mats: { Dreamfoil: 3, "Mountain Silversage": 1, "Crystal Vial": 1 },
        },
        {
          id: "flask_spell",
          cat: "spell",
          ico: "üß™",
          name: "Supreme Flask",
          rarity: "rare",
          desc: "+150 Spell Power.",
          mats: {
            Dreamfoil: 30,
            "Mountain Silversage": 10,
            "Black Lotus": 1,
            "Crystal Vial": 1,
          },
        },

        {
          id: "titans",
          cat: "utils",
          ico: "üèîÔ∏è",
          name: "Flask of Titans",
          rarity: "rare",
          desc: "+1200 Health.",
          mats: {
            Gromsblood: 30,
            "Stonescale Oil": 10,
            "Black Lotus": 1,
            "Crystal Vial": 1,
          },
        },
        {
          id: "mana",
          cat: "utils",
          ico: "üíß",
          name: "Major Mana",
          rarity: "uncommon",
          desc: "Restores Mana.",
          mats: { Dreamfoil: 3, Icecap: 2, "Crystal Vial": 1 },
        },
        {
          id: "f_res",
          cat: "utils",
          ico: "üõ°Ô∏èüî•",
          name: "Fire Prot",
          rarity: "uncommon",
          desc: "Absorbs Fire.",
          mats: { "Elemental Fire": 1, Dreamfoil: 1, "Crystal Vial": 1 },
        },
        {
          id: "n_res",
          cat: "utils",
          ico: "üõ°Ô∏èüåø",
          name: "Nature Prot",
          rarity: "uncommon",
          desc: "Absorbs Nature.",
          mats: { "Elemental Earth": 1, Dreamfoil: 1, "Crystal Vial": 1 },
        },
        {
          id: "s_res",
          cat: "utils",
          ico: "üõ°Ô∏èüåë",
          name: "Shadow Prot",
          rarity: "uncommon",
          desc: "Absorbs Shadow.",
          mats: { "Shadow Oil": 1, Dreamfoil: 1, "Crystal Vial": 1 },
        },
      ];

      let selected = {};
      let inventory = {};

      function formatPrice(gold) {
        const g = Math.floor(gold);
        const s = Math.round((gold - g) * 100);
        return `<span class="gold">${g}g</span> <span class="silver">${s}s</span>`;
      }

      function convertCopper(amount) {
        // 1 Gold = 10,000 Copper | 1 Silver = 100 Copper
        const gold = Math.floor(amount / 10000);
        const silver = Math.floor((amount % 10000) / 100);
        const copper = amount % 100;
        return {
          gold: gold,
          silver: silver,
          copper: copper,
        };
      }

      function convertAndDisplay(priceItem) {
                   const price = convertCopper(priceItem);
            return [
              price.gold > 0 && `<div class="flex items-center">${price.gold}<img src="https://wow.zamimg.com/images/icons/money-gold.gif"></div>`,
              price.silver > 0 && `<div class="flex items-center">${price.silver}<img src="https://wow.zamimg.com/images/icons/money-silver.gif"></div>`,
              price.copper > 0 && `<div class="flex items-center">${price.copper}<img src="https://wow.zamimg.com/images/icons/money-copper.gif"></div>`,
            ]
              .filter(Boolean)
              .join(" ");
      }

      function getTimeAgo(date) {
  const now = new Date();
  const past = new Date(date);
  const diffInMs = now - past; // Difference in milliseconds

  // Define time units in milliseconds
  const msInDay = 1000 * 60 * 60 * 24;
  const msInHour = 1000 * 60 * 60;
  const msInMinute = 1000 * 60;

  // Calculate units using remainder logic
  const days = Math.floor(diffInMs / msInDay);
  const hours = Math.floor((diffInMs % msInDay) / msInHour);
  const minutes = Math.floor((diffInMs % msInHour) / msInMinute);

  return [
              days> 0 && `${days}d`,
              hours > 0 && `${hours}h`,
              minutes > 0 && `${minutes}m`,
            ]
              .filter(Boolean)
              .join(" ");
}

      function renderSidebar() {
        const container = document.getElementById("plant-list");
        container.innerHTML = plants
          .map((p) => {
            const displayPrice = convertAndDisplay(p.data.minimum_buyout)
            return `
                <div class="group border-l-2 border-zinc-800 hover:border-yellow-600 pl-3 py-1">
                    <div class="flex justify-between items-start tooltip-container">
                        <div class="tooltip-text">
                            <p class="text-yellow-500 font-black mb-1">${p.name} (${p.data.item_count})</p>
                            <div class="text-[10px] text-zinc-500 uppercase border-t border-zinc-800 pt-2 font-mono">
                               <div class="flex justify-between">Min byout <div class="flex gap-2">${convertAndDisplay(p.data.minimum_buyout)}</div></div>
                               <div class="flex justify-between">Average <div class="flex gap-2">${convertAndDisplay(p.data.avg_price)}</div></div>
                            </div>
                        </div>
                        <p class="text-xs font-bold rarity-${p.rarity}">${p.name} </p>
                        <span class="text-[10px] font-mono text-yellow-500/80 flex gap-2">${convertAndDisplay(p.data.minimum_buyout)}</span>
                    </div>
                    <p class="text-[9px] text-zinc-600 font-mono">ID: ${p.id} Count: ${p.data.item_count}</p>
                </div>
            `;
          })
          .join("");
      }

      async function init() {
        await loadPlants();
        renderSidebar();
        potions.forEach((p) => {
          const container = document.getElementById(`${p.cat}-list`);
          const div = document.createElement("div");
          div.className =
            "flex items-center justify-between p-2 rounded-lg bg-zinc-900/40 border border-zinc-800 group";
          div.innerHTML = `
                    <div class="tooltip-container">
                        <span class="cursor-help flex items-center">
                            <span class="mr-2">${p.ico}</span>
                            <span class="rarity-${p.rarity} font-semibold">${p.name}</span>
                        </span>
                        <div class="tooltip-text">
                            <p class="text-yellow-500 font-black mb-1">${p.name}</p>
                            <p class="text-zinc-400 italic mb-2">"${p.desc}"</p>
                            <div class="text-[10px] text-zinc-500 uppercase border-t border-zinc-800 pt-2 font-mono">
                                ${Object.entries(p.mats)
                                  .map(([m, q]) => `‚Ä¢ ${q}x ${m}`)
                                  .join("<br>")}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center rounded overflow-hidden">
                        <button class="stepper-btn" onclick="modifyStep('${p.id}', -1)">‚àí</button>
                        <input type="number" id="qty-${p.id}" value="0" min="0" 
                               class="input-qty w-10 text-center text-xs py-1 font-bold"
                               oninput="handleInput('${p.id}', this.value)">
                        <button class="stepper-btn" onclick="modifyStep('${p.id}', 1)">+</button>
                    </div>
                `;
          container.appendChild(div);
        });
      }

      function modifyStep(id, delta) {
        const current = selected[id] || 0;
        const next = Math.max(0, current + delta);
        updateLogic(id, next);
      }

      function handleInput(id, val) {
        const next = Math.max(0, parseInt(val) || 0);
        updateLogic(id, next);
      }

      function updateLogic(id, val) {
        selected[id] = val;
        document.getElementById(`qty-${id}`).value = val;
        updateRecap();
      }

      function updateInv(mat, val) {
        inventory[mat] = parseInt(val) || 0;
        updateRecap();
      }

      function updateRecap() {
        const totals = {};
        potions.forEach((p) => {
          const qty = selected[p.id] || 0;
          if (qty > 0) {
            for (const [mat, req] of Object.entries(p.mats)) {
              totals[mat] = (totals[mat] || 0) + req * qty;
            }
          }
        });

        const body = document.getElementById("recap-body");
        const empty = document.getElementById("empty-msg");
        body.innerHTML = "";

        const sorted = Object.keys(totals).sort();

        if (sorted.length === 0) {
          empty.style.display = "block";
          return;
        }
        empty.style.display = "none";

        sorted.forEach((mat) => {
          console.log('mat', mat)
          const req = totals[mat];
          const have = inventory[mat] || 0;
          const diff = Math.max(0, req - have);
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td class="py-4 font-medium text-zinc-300">${mat}</td>
                    <td class="py-4 text-center">
                        <input type="number" min="0" value="${have}" class="bg-zinc-900 border border-zinc-700 w-20 text-center rounded-md text-xs py-1.5 focus:ring-1 ring-yellow-500 outline-none"
                               onchange="updateInv('${mat}', this.value)">
                    </td>
                    <td class="py-4 text-center text-yellow-500 font-bold text-lg">${req}</td>
                    <td class="py-4 text-right">
                        ${
                          diff > 0
                            ? `<span class="text-red-500 font-bold bg-red-500/10 px-3 py-1 rounded">FARM ${diff}</span>`
                            : `<span class="text-green-500 font-bold bg-green-500/10 px-3 py-1 rounded">READY</span>`
                        }
                    </td>
                `;
          body.appendChild(tr);
        });

        const allPlantNeeded = sorted.map(item => {
          const itemPlant = plants.find(plant => plant.name === item)
          if(itemPlant) {
            return {
              name : item,
              price : itemPlant.data.minimum_buyout,
              plant:itemPlant,
              quantity : totals[item]
            }
          }
          return;

        }).filter(item => item !== undefined)

        const grandTotal = allPlantNeeded.reduce((prices, {price, quantity}) => {
          return prices + (price*quantity)
        }, 0)

        console.log('allPlantNeeded', allPlantNeeded, grandTotal)
        document.getElementById("total-cost").innerHTML = 
          `Total:&nbsp;${convertAndDisplay(grandTotal)}`;
      }

      init();
    </script>
  </body>
</html>
